library(tidyverse)
library(countrycode)
library(readxl)
library(magick)

full.data.link <- "https://covid.ourworldindata.org/data/ecdc/full_data.csv"
full.dt.in <- read.csv(full.data.link)


### Get a list of SSA countries

wb.path <- "wb_country_codes.csv"
wb.in <- read.csv(wb.path)

ssa.codes <- wb.in %>%
    filter(region == "Sub-Saharan Africa") %>%
    pull(code)  %>%
    as.character()


### Prepare dataset for plotting

dt <- full.dt.in %>%
    mutate(ccode = countrycode(
               sourcevar = .$location,
               origin = "country.name",
               destination ="iso3c"),
           is.ssa =  ifelse(ccode %in% ssa.codes,
                            TRUE, FALSE),
           date = as.Date(date))

dt.ssa <- dt %>%
    filter(is.ssa ==  TRUE)

### Define some general parameters

latest.date <- max(dt$date)

general.theme <- theme_minimal() +
    theme(axis.text.x = element_text(size = 6))


### Plot cases

latest.cases <- dt.ssa %>%
    filter(date == latest.date) %>%
    ggplot(aes(x = ccode, y = total_cases)) +
    geom_point() +
    scale_y_continuous(trans  = "log10") +
    general.theme

### Make the trend plot
translate.date <- function(date.col){
    seq_along(date.col) - 1
}

get.days.since.n <- function(country.dt, n.cases = 50){

    earliest.date <- country.dt %>%
        mutate(more.than.n = total_cases >= n.cases) %>%
        filter(more.than.n ==  TRUE) %>%
        pull(date)  %>%
        min()

    more.cases.df <- country.dt %>%
        filter(date >= earliest.date) %>%
        mutate(date.zeroed = translate.date(date))

    return(more.cases.df)
}

double.day.function <- function(doubling.days,
                                time.vec,
                                n.cases = Ncases){
    n.cases * (2  ^ (time.vec/doubling.days))
}

make.doubling.df <- function(doubling.days.list,
                             time.vec.in,
                             ncases.in = Ncases){

    doubling.times.list <- lapply(
        doubling.days.list,
        double.day.function,
        time.vec = time.vec.in,
        n.cases = ncases.in)

    names(doubling.times.list) <- paste0("days",
                                         doubling.days.list)

    doubling.df <- data.frame(doubling.times.list) %>%
        mutate(date.zeroed = time.vec.in) %>%
        pivot_longer(cols = starts_with("days"),
                     names_to = "doubling_time",
                     values_to = "number_cases")

    plot.df <- doubling.df %>%
        group_by(doubling_time) %>%
        group_modify(~get.doubling.plot.coords(.x))
    return(list(doubling.df, plot.df))

}

get.doubling.plot.coords <- function(ddf){
    ddf %>%
        filter(number_cases < max.cases.plot) %>%
        filter(date.zeroed == max(date.zeroed))
}

get.levels.of.factor <- function(df.in, factor.name, value.name){
    ordered.out <- df.in %>%
        arrange_(value.name) %>%
        select_(factor.name) %>%
        pluck(1)  %>%
        unique() %>%
        as.character()

    return(rev(ordered.out))
}

Ncases <- 100

ssa.50 <- dt.ssa %>%
    group_by(location) %>%
    group_modify(~get.days.since.n(.x, n.cases = Ncases)) %>%
    ungroup() %>%
    mutate(location = as.character(location),
           location = factor(
               location,
               levels = get.levels.of.factor(
                   df.in = filter(., date == latest.date),
                   "location", "total_cases")),
           ordered = TRUE)

days.since.n <- ssa.50$date.zeroed %>% unique()

doubling.days.plot <- c(1, 5, 10)
doubling.df.list <- make.doubling.df(doubling.days.plot, days.since.n)

doubling.df <- doubling.df.list[[1]]
doubling.df.plot <- doubling.df.list[[2]]

max.cases <- max(ssa.50$total_cases)
max.cases.plot <- max.cases + 20
min.cases.plot <- min(ssa.50$total_cases) -1

N.countries <- length(ssa.50$location %>% unique())

plot.title.base  <- paste("%s African countries have more",
                          "than %s confirmed COVID-19 cases")

caption.text <- paste("Author elaborations based on data from",
                 "Our World in Data. Plot inspired by FT")

plot.title <- sprintf(plot.title.base, N.countries, Ncases)

trend.plot <- ssa.50 %>%
    ggplot(aes(x = date.zeroed,
                   y = total_cases, colour = location)) +
    geom_point() +
    geom_line() +
    geom_line(data = doubling.df,
              inherit.aes = FALSE,
              aes(x = date.zeroed,
                  y = number_cases,
                  linetype = doubling_time),
              colour = "gray") +
    geom_text(data = doubling.df.plot,
              inherit.aes  = FALSE,
              aes(x = date.zeroed,
                  y = number_cases,
                  label = doubling_time)) +
    scale_y_continuous(trans = "log10",
                       limits = c(min.cases.plot, max.cases.plot)) +
    labs(title = plot.title,
         caption = caption.text)  +
    xlab("Days since the 50th case was reported") +
    ylab("Total number of cases") +
    guides(linetype = "none")  +
    general.theme +
    theme(legend.title = element_blank(),
          plot.title.position = "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(
              hjust = 0,
              size = 7,
              margin = margin(t = 0.5, unit = "cm")))


add.e4t.branding <- function(plot, plot.name){

    plot.png <- paste0(plot.name, ".png")
    ggsave(plot.png,
           width = 23.8,
           height = 13.8,
           units = "cm",
           plot = plot)

    stats.png <- image_read(plot.png)

    logo <- image_read("../e4t_logo.png")%>%
        image_resize("x150")

    twitter <- image_read("../e4t_twitter.png") %>%
        image_resize("x90")

    plot.img <- image_composite(stats.png, logo,
                                offset = "+2250+0") %>%
        image_composite(twitter, offset = "+1250+1950")

    image_write(plot.img,
                path = plot.png)
    return(plot.img)
}


plot.final <- add.e4t.branding(trend.plot,
                               "SSA_more_than_100")
